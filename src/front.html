<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¬éšœè¾…åŠ©è½¬å½•ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid #333;
            margin-bottom: 20px;
        }
        header h1 {
            color: #00d4ff;
            font-size: 28px;
        }
        .status-bar {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 10px;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #666;
        }
        .status-dot.connected { background: #00ff88; }
        .status-dot.disconnected { background: #ff4444; }
        .status-dot.processing { background: #ffaa00; animation: pulse 1s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }
        .video-section {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
        }
        #videoCanvas {
            width: 100%;
            display: block;
        }
        .overlay-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        #overlayCanvas {
            width: 100%;
            height: 100%;
        }
        .tom-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.85);
            border: 1px solid #00d4ff;
            border-radius: 10px;
            padding: 15px;
            max-width: 400px;
            display: none;
        }
        .tom-panel.visible { display: block; }
        .tom-panel h3 {
            color: #00d4ff;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .tom-item {
            margin: 8px 0;
            font-size: 13px;
            line-height: 1.5;
        }
        .tom-item .label {
            color: #888;
            margin-right: 8px;
        }
        .tom-item .value { color: #fff; }
        .tom-item.emotion .value { color: #ffaa00; }
        .tom-item.intent .value { color: #00ff88; }
        .tom-item.suggest .value { color: #ff88ff; }
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .panel {
            background: #252540;
            border-radius: 12px;
            padding: 15px;
        }
        .panel h2 {
            color: #00d4ff;
            font-size: 16px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }
        .transcript-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .transcript-item {
            padding: 10px;
            margin: 8px 0;
            background: #1a1a2e;
            border-radius: 8px;
            border-left: 3px solid #00d4ff;
        }
        .transcript-item.speaking {
            border-left-color: #00ff88;
            background: #1a2a1e;
        }
        .transcript-speaker {
            color: #00d4ff;
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 4px;
        }
        .transcript-text {
            font-size: 14px;
            line-height: 1.5;
        }
        .person-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .person-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: #1a1a2e;
            border-radius: 8px;
        }
        .person-item.speaking {
            background: #1a2a1e;
            border: 1px solid #00ff88;
        }
        .person-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00d4ff, #0088ff);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .person-info { flex: 1; }
        .person-name { font-weight: bold; }
        .person-conf {
            font-size: 12px;
            color: #888;
        }
        .speaking-indicator {
            width: 20px;
            height: 20px;
        }
        .speaking-indicator.active {
            animation: speak 0.5s infinite;
        }
        @keyframes speak {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #00d4ff, #0088ff);
            color: #fff;
        }
        .btn-primary:hover { transform: translateY(-2px); }
        .btn-danger {
            background: #ff4444;
            color: #fff;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1a1a2e; }
        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ§ å¬éšœè¾…åŠ©è½¬å½•ç³»ç»Ÿ</h1>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot" id="wsStatus"></div>
                    <span id="wsStatusText">æœªè¿æ¥</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="remoteStatus"></div>
                    <span id="remoteStatusText">è¿œç¨‹æœåŠ¡</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="asrStatus"></div>
                    <span id="asrStatusText">è¯­éŸ³è¯†åˆ«</span>
                </div>
            </div>
        </header>
        <div class="main-content">
            <div class="video-section">
                <canvas id="videoCanvas" width="1280" height="720"></canvas>
                <div class="overlay-container">
                    <canvas id="overlayCanvas" width="1280" height="720"></canvas>
                </div>
                <div class="tom-panel" id="tomPanel">
                    <h3>ğŸ§  ToM å¿ƒæ™ºåˆ†æ</h3>
                    <div class="tom-item emotion">
                        <span class="label">æƒ…æ„Ÿ:</span>
                        <span class="value" id="tomEmotion">-</span>
                    </div>
                    <div class="tom-item intent">
                        <span class="label">æ„å›¾:</span>
                        <span class="value" id="tomIntent">-</span>
                    </div>
                    <div class="tom-item">
                        <span class="label">å¿ƒç†:</span>
                        <span class="value" id="tomMental">-</span>
                    </div>
                    <div class="tom-item suggest">
                        <span class="label">å»ºè®®:</span>
                        <span class="value" id="tomSuggest">-</span>
                    </div>
                </div>
            </div>
            <div class="sidebar">
                <div class="panel">
                    <h2>ğŸ‘¥ æ£€æµ‹åˆ°çš„äººç‰©</h2>
                    <div class="person-list" id="personList">
                        <div style="color:#666;text-align:center;padding:20px;">ç­‰å¾…æ£€æµ‹...</div>
                    </div>
                </div>
                <div class="panel">
                    <h2>ğŸ“ å®æ—¶è½¬å½•</h2>
                    <div class="transcript-list" id="transcriptList">
                        <div style="color:#666;text-align:center;padding:20px;">ç­‰å¾…è½¬å½•...</div>
                    </div>
                </div>
                <div class="panel">
                    <h2>âš™ï¸ æ§åˆ¶</h2>
                    <div class="controls">
                        <button class="btn btn-primary" id="btnConnect">è¿æ¥</button>
                        <button class="btn btn-danger" id="btnDisconnect" disabled>æ–­å¼€</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
```

<script>
// ==================== çŠ¶æ€ç®¡ç† ====================
const state = {
    ws: null,
    connected: false,
    persons: [],
    currentSpeaker: null,
    transcripts: [],
    tomResult: null,
    videoWidth: 1280,
    videoHeight: 720
};

// ==================== DOMå…ƒç´  ====================
const videoCanvas = document.getElementById('videoCanvas');
const overlayCanvas = document.getElementById('overlayCanvas');
const videoCtx = videoCanvas.getContext('2d');
const overlayCtx = overlayCanvas.getContext('2d');
const personList = document.getElementById('personList');
const transcriptList = document.getElementById('transcriptList');
const tomPanel = document.getElementById('tomPanel');
const btnConnect = document.getElementById('btnConnect');
const btnDisconnect = document.getElementById('btnDisconnect');

// ==================== WebSocketè¿æ¥ ====================
function connect() {
    const wsUrl = 'ws://localhost:8766';  // æœ¬åœ°å‰ç«¯WebSocketç«¯å£
    state.ws = new WebSocket(wsUrl);
    
    state.ws.onopen = () => {
        state.connected = true;
        updateStatus('wsStatus', 'connected', 'å·²è¿æ¥');
        btnConnect.disabled = true;
        btnDisconnect.disabled = false;
        console.log('WebSocketå·²è¿æ¥');
    };
    
    state.ws.onclose = () => {
        state.connected = false;
        updateStatus('wsStatus', 'disconnected', 'å·²æ–­å¼€');
        btnConnect.disabled = false;
        btnDisconnect.disabled = true;
        console.log('WebSocketå·²æ–­å¼€');
    };
    
    state.ws.onerror = (err) => {
        console.error('WebSocketé”™è¯¯:', err);
        updateStatus('wsStatus', 'disconnected', 'è¿æ¥é”™è¯¯');
    };
    
    state.ws.onmessage = (event) => {
        try {
            const data = JSON.parse(event.data);
            handleMessage(data);
        } catch (e) {
            console.error('è§£ææ¶ˆæ¯å¤±è´¥:', e);
        }
    };
}

function disconnect() {
    if (state.ws) {
        state.ws.close();
        state.ws = null;
    }
}

// ==================== æ¶ˆæ¯å¤„ç† ====================
function handleMessage(data) {
    switch (data.type) {
        case 'frame':
            updateFrame(data);
            break;
        case 'detection':
            updateDetection(data);
            break;
        case 'transcript':
            addTranscript(data);
            break;
        case 'tom':
            updateToM(data);
            break;
        case 'status':
            updateSystemStatus(data);
            break;
    }
}

// ==================== è§†é¢‘å¸§æ›´æ–° ====================
function updateFrame(data) {
    if (!data.image) return;
    
    const img = new Image();
    img.onload = () => {
        state.videoWidth = img.width;
        state.videoHeight = img.height;
        videoCanvas.width = img.width;
        videoCanvas.height = img.height;
        overlayCanvas.width = img.width;
        overlayCanvas.height = img.height;
        videoCtx.drawImage(img, 0, 0);
        drawOverlay();
    };
    img.src = 'data:image/jpeg;base64,' + data.image;
}

// ==================== æ£€æµ‹ç»“æœæ›´æ–° ====================
function updateDetection(data) {
    state.persons = data.persons || [];
    state.currentSpeaker = data.speaker_id;
    
    // æ›´æ–°äººç‰©åˆ—è¡¨
    renderPersonList();
    
    // é‡ç»˜è¦†ç›–å±‚
    drawOverlay();
}

// ==================== ç»˜åˆ¶è¦†ç›–å±‚ï¼ˆæ£€æµ‹æ¡†+æ–‡å­—ï¼‰ ====================
function drawOverlay() {
    overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
    
    const scaleX = overlayCanvas.width / state.videoWidth;
    const scaleY = overlayCanvas.height / state.videoHeight;
    
    state.persons.forEach(person => {
        const [x1, y1, x2, y2] = person.bbox;
        const sx1 = x1 * scaleX;
        const sy1 = y1 * scaleY;
        const sx2 = x2 * scaleX;
        const sy2 = y2 * scaleY;
        const width = sx2 - sx1;
        const height = sy2 - sy1;
        
        const isSpeaking = person.label === state.currentSpeaker;
        
        // ç»˜åˆ¶æ£€æµ‹æ¡†
        overlayCtx.strokeStyle = isSpeaking ? '#00ff88' : '#00d4ff';
        overlayCtx.lineWidth = isSpeaking ? 4 : 2;
        overlayCtx.strokeRect(sx1, sy1, width, height);
        
        // ç»˜åˆ¶æ ‡ç­¾èƒŒæ™¯
        const labelText = person.label + (isSpeaking ? ' ğŸ¤' : '');
        overlayCtx.font = 'bold 16px Microsoft YaHei';
        const textWidth = overlayCtx.measureText(labelText).width;
        
        overlayCtx.fillStyle = isSpeaking ? 'rgba(0, 255, 136, 0.9)' : 'rgba(0, 212, 255, 0.9)';
        overlayCtx.fillRect(sx1, sy1 - 28, textWidth + 16, 26);
        
        // ç»˜åˆ¶æ ‡ç­¾æ–‡å­—
        overlayCtx.fillStyle = '#000';
        overlayCtx.fillText(labelText, sx1 + 8, sy1 - 8);
        
        // å¦‚æœæ­£åœ¨è¯´è¯ï¼Œæ˜¾ç¤ºæœ€æ–°è½¬å½•æ–‡å­—
        if (isSpeaking && state.transcripts.length > 0) {
            const lastTranscript = state.transcripts[state.transcripts.length - 1];
            if (lastTranscript.speaker === person.label) {
                drawSpeechBubble(sx1 + width/2, sy1 - 40, lastTranscript.text);
            }
        }
    });
}

// ==================== ç»˜åˆ¶å¯¹è¯æ°”æ³¡ ====================
function drawSpeechBubble(x, y, text) {
    const maxWidth = 300;
    const padding = 12;
    const fontSize = 14;
    
    overlayCtx.font = fontSize + 'px Microsoft YaHei';
    
    // æ–‡å­—æ¢è¡Œå¤„ç†
    const words = text.split('');
    const lines = [];
    let currentLine = '';
    
    for (const char of words) {
        const testLine = currentLine + char;
        if (overlayCtx.measureText(testLine).width > maxWidth - padding * 2) {
            lines.push(currentLine);
            currentLine = char;
        } else {
            currentLine = testLine;
        }
    }
    if (currentLine) lines.push(currentLine);
    
    // é™åˆ¶æœ€å¤š3è¡Œ
    const displayLines = lines.slice(-3);
    
    const lineHeight = fontSize + 6;
    const bubbleWidth = Math.min(maxWidth, Math.max(...displayLines.map(l => overlayCtx.measureText(l).width)) + padding * 2);
    const bubbleHeight = displayLines.length * lineHeight + padding * 2;
    
    const bubbleX = x - bubbleWidth / 2;
    const bubbleY = y - bubbleHeight - 10;
    
    // ç»˜åˆ¶æ°”æ³¡èƒŒæ™¯
    overlayCtx.fillStyle = 'rgba(0, 0, 0, 0.85)';
    overlayCtx.beginPath();
    overlayCtx.roundRect(bubbleX, bubbleY, bubbleWidth, bubbleHeight, 8);
    overlayCtx.fill();
    
    // ç»˜åˆ¶æ°”æ³¡è¾¹æ¡†
    overlayCtx.strokeStyle = '#00ff88';
    overlayCtx.lineWidth = 2;
    overlayCtx.stroke();
    
    // ç»˜åˆ¶å°ä¸‰è§’
    overlayCtx.fillStyle = 'rgba(0, 0, 0, 0.85)';
    overlayCtx.beginPath();
    overlayCtx.moveTo(x - 8, bubbleY + bubbleHeight);
    overlayCtx.lineTo(x, bubbleY + bubbleHeight + 10);
    overlayCtx.lineTo(x + 8, bubbleY + bubbleHeight);
    overlayCtx.fill();
    
    // ç»˜åˆ¶æ–‡å­—
    overlayCtx.fillStyle = '#fff';
    displayLines.forEach((line, i) => {
        overlayCtx.fillText(line, bubbleX + padding, bubbleY + padding + (i + 1) * lineHeight - 4);
    });
}

// ==================== è½¬å½•æ›´æ–° ====================
function addTranscript(data) {
    state.transcripts.push({
        speaker: data.speaker,
        text: data.text,
        timestamp: Date.now()
    });
    
    // ä¿ç•™æœ€è¿‘20æ¡
    if (state.transcripts.length > 20) {
        state.transcripts = state.transcripts.slice(-20);
    }
    
    renderTranscriptList();
    drawOverlay();
}

// ==================== ToMæ›´æ–° ====================
function updateToM(data) {
    state.tomResult = data;
    
    document.getElementById('tomEmotion').textContent = 
        `${data.emotion} (${Math.round(data.confidence * 100)}%)`;
    document.getElementById('tomIntent').textContent = data.intent || '-';
    document.getElementById('tomMental').textContent = data.mental_state || '-';
    document.getElementById('tomSuggest').textContent = data.suggested_response || '-';
    
    tomPanel.classList.add('visible');
    
    // 5ç§’åéšè—
    setTimeout(() => {
        tomPanel.classList.remove('visible');
    }, 8000);
}

// ==================== æ¸²æŸ“äººç‰©åˆ—è¡¨ ====================
function renderPersonList() {
    if (state.persons.length === 0) {
        personList.innerHTML = '<div style="color:#666;text-align:center;padding:20px;">ç­‰å¾…æ£€æµ‹...</div>';
        return;
    }
    
    personList.innerHTML = state.persons.map(person => {
        const isSpeaking = person.label === state.currentSpeaker;
        return `
            <div class="person-item ${isSpeaking ? 'speaking' : ''}">
                <div class="person-avatar">${person.label.replace('person', 'P')}</div>
                <div class="person-info">
                    <div class="person-name">${person.label}</div>
                    <div class="person-conf">ç½®ä¿¡åº¦: ${(person.confidence * 100).toFixed(1)}%</div>
                </div>
                ${isSpeaking ? '<div class="speaking-indicator active">ğŸ¤</div>' : ''}
            </div>
        `;
    }).join('');
}

// ==================== æ¸²æŸ“è½¬å½•åˆ—è¡¨ ====================
function renderTranscriptList() {
    if (state.transcripts.length === 0) {
        transcriptList.innerHTML = '<div style="color:#666;text-align:center;padding:20px;">ç­‰å¾…è½¬å½•...</div>';
        return;
    }
    
    transcriptList.innerHTML = state.transcripts.slice(-10).map(t => {
        const isSpeaking = t.speaker === state.currentSpeaker;
        return `
            <div class="transcript-item ${isSpeaking ? 'speaking' : ''}">
                <div class="transcript-speaker">${t.speaker}</div>
                <div class="transcript-text">${t.text}</div>
            </div>
        `;
    }).join('');
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    transcriptList.scrollTop = transcriptList.scrollHeight;
}

// ==================== çŠ¶æ€æ›´æ–° ====================
function updateStatus(elementId, status, text) {
    const dot = document.getElementById(elementId);
    const textEl = document.getElementById(elementId + 'Text');
    
    dot.className = 'status-dot ' + status;
    if (textEl) textEl.textContent = text;
}

function updateSystemStatus(data) {
    if (data.remote !== undefined) {
        updateStatus('remoteStatus', data.remote ? 'connected' : 'disconnected', 
            data.remote ? 'å·²è¿æ¥' : 'æœªè¿æ¥');
    }
    if (data.asr !== undefined) {
        updateStatus('asrStatus', data.asr ? 'processing' : 'disconnected',
            data.asr ? 'è¯†åˆ«ä¸­' : 'å¾…æœº');
    }
}

// ==================== äº‹ä»¶ç»‘å®š ====================
btnConnect.addEventListener('click', connect);
btnDisconnect.addEventListener('click', disconnect);

// é¡µé¢åŠ è½½åè‡ªåŠ¨è¿æ¥
window.addEventListener('load', () => {
    setTimeout(connect, 500);
});
</script>
</body>
</html>
